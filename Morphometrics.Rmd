---
title: "Morphometrics"
author: "Michelle DePrenger-Levin"
date: "November 11, 2016"
output: pdf_document
---

```{r, eval=FALSE}
install.packages("shapes")
library(shapes)
```


<http://life.bio.sunysb.edu/morph/>    
> software    
  > Utility programs    
  Download tpsUtil  
  > Thin-plate spline
  Downlaod tpsRelw   
  Download tpsSmall     

<http://swordtail.tamu.edu/anyfish/Modeling_body_and_fin_shape_%28morphometrics%29>
1. Build a TPS file using tpsUtil   
2. Open tpsUtil    
  * Build tps file from images      
  * Input directory -> go to file with images   
  * Output to create file where you'll save info  
  * Setup - check all of images you want, create   
  
3. Can view that setup file in a text editor   
  * LM=0 : "landmark ID"    
  * info for each image selected     
  * after the landmarks are set, that LM will have numbers for each.    
  
4. Landmark tps files    
  * Open tpsDig    
  * Open tps file    
  * Input source, open the tps file   
  * Set scale: Options>Image tools or tool bar picture with tools images    
  ** a) Measure tab    
        Reference length - scale to image   
        Set scale > click and click along ruler   
     b) Apply landmark > Digitize landmarks (circle and cross image button)    
        cursor becomes circle cross   
        click on landmarks - the first and 22nd are identical (or some number - the midway?)    
        match landmarking guide - exact order of landmarks in each image    
        number and order must match all     
        File > Save data > save and overwrite  
      c) Visulaization aids    
        * Menu > preliminatries > option: create or edit wireframe   
        * Menu > file > option: import outline file    
      d) Convert TPS into NTS     
        * TPSUtil, convert TPS/NTS file   
        * check box for using the sacale factor    
        * check box for using image names as labels  
      e) Procrustes superimposed   
        * Menu > preliminatries> option: Procrustes fit  
        
5. TPSSmall - test whether variation in shape is too large   
  * regresses through the origin the set of Euclidean distances in the Euclidean space onto the set of Procrutes shape distances      
  * want approximation to give regression with both slope and correlation virtually equal to 1    

6. Consensus file (An average of a population)   
  * Open tpsRelw    
      * Landmark all LMs, combine and generate a consensus for that population   
  * Data > open the TPS file   
  * Compute > Consensus   
    * Display > Consensus   
      * see the cons   
      * File > Save > Save consensus... > Save with ".TPS"    

Landmark data
```{r}
sites <- c("AS","BR","FR","RN","TC")

landmarks <- lapply(sites, function(x){
  site <- read.csv(paste("Q:/Research/All_Projects_by_Species/Phacelia SPECIES/Phacelia_formosula/Phacelia formosula_abiotic/Landmark_",x,".csv", sep=""), header=FALSE)
  sitexy <- site[complete.cases(site),]
  colnames(sitexy) <- c("X","Y")
  ind <- seq(23,nrow(site),25)
  indivduals <- sapply(gsub(".*[=]|[.].*", "", site[ind,1]), function(x) rep(x,21))
  sitexy$Ind <- c(indivduals)
  sitexy$Ldm <- rep(1:21,nrow(sitexy)/21)
  sitexy
})

ldms <- do.call(rbind,landmarks)
head(ldms)


#each column as a landmark
head(ldms)

wide.ldms <- reshape(ldms, idvar="Ind", timevar = "Ldm", direction = "wide")


```

### Exclude TC
# plant height and width (Atwood?) 
# go back and measure seed entire or pitted FC and TC and detect differences? add to morph data
#abiotic envelope

# Morphometic and DAPC including TC and without
biological conservation
diveristy and distributions - conservation and testing a species hypothosis, what lines of evidence needed to split vs. lump... 

Edwards Knowles 2014 PRSB
```{r}
library(MASS)
library(cluster)
library(dendextend)
library("ape")
library(ggplot2)
library(vegan)

# Hausdorf & Hennig followed: 4 dimensions retained so no more than five individuals needed to recognize a cluster
head(wide.ldms)
wide.ldms1 <- wide.ldms[-(grep("TC", wide.ldms$Ind)),]

phdaisy_wide1 <- daisy(wide.ldms1[,-1], metric="gower")
phclust_wide1 <- hclust(phdaisy_wide1)

ph.dendwide1 <- as.dendrogram(phclust_wide1)

ord <- isoMDS(phdaisy_wide1)
code <- substr(wide.ldms1$Ind,1,2)

ord.xy1 <- data.frame(wide.ldms1$Ind,ord$points,code)
colnames(ord.xy1) <- c("Individual","X","Y","Site")

ggplot(ord.xy1, aes(X,Y,colour=Site))+
  geom_point()+
  stat_ellipse()+
  theme_bw()

#####
phdaisy_wide <- daisy(wide.ldms[,-1], metric="gower")
phclust_wide <- hclust(phdaisy_wide)

ph.dendwide <- as.dendrogram(phclust_wide)

plot(phclust_wide, labels = wide.ldms$Ind, cex = 0.75)

nrow(wide.ldms)
nrow(ord$points)

par(mar=c(5,5,2,2))
ord <- isoMDS(phdaisy_wide)
code <- substr(wide.ldms$Ind,1,2)

ord.xy <- data.frame(wide.ldms$Ind,ord$points,code)
colnames(ord.xy) <- c("Individual","X","Y","Site")

ggplot(ord.xy, aes(X,Y,colour=Site))+
  geom_point()+
  stat_ellipse()


```


Merge morphometrics 
```{r}
phfo <- read.csv("Q:/Research/Lab/Projects/Phacelia formosula/Morphology Images_phfo/Phacelia.formosula.data.2014CSV.csv")

head(phfo)
phfo <- phfo[,-(18:19)]
# Change population code to match

unique(phfo$Population.Code)
unique(code)
wide.ldms$Ind <- sapply(wide.ldms$Ind, function(x) gsub("FR","FC",x))

ph.merg <- merge(wide.ldms, phfo, by.x = "Ind", by.y = "Individual.ID")
names(ph.merg)

table(ph.merg$Population.Code)

ph.daisy <- daisy(ph.merg[,c(2:43,50:59)], metric = "gower")
phclust.all <- hclust(ph.daisy)

plot(phclust.all, labels = ph.merg$Species)
plot(phclust.all, labels = ph.merg$Population.Code)

```

```{r}

#par(mar=c(5,5,2,2))
ord.1 <- isoMDS(ph.daisy)

ord.xy.1 <- data.frame(ph.merg,ord.1$points)

ggplot(ord.xy.1, aes(X1,X2,colour=Species))+
  geom_point()+
  stat_ellipse()+
  theme_bw()

###vegan vignette
ord.meta <- metaMDS(ph.daisy)

plot(ord.meta)

plot(ord,meta, type = "n")
points(ord.meta, display = "sites", cex = 0.8, pch=21, col="red", bg="yellow")
text(ord.meta, display = "spec", cex=0.7, col="blue")


#############
fit <- isoMDS(ph.daisy)
fit

plot(fit$points[,1], fit$points[,2], type="n")
text(fit$points[,1], fit$points[,2],labels = ph.merg$Population.Code, cex = 0.7)
```


Klingenberg et al 2011
```{r}


```





  