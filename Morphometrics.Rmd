---
title: "Morphometrics"
author: "Michelle DePrenger-Levin"
date: "November 11, 2016"
output: pdf_document
---

```{r, eval=FALSE}
install.packages("shapes")
library(shapes)
```


<http://life.bio.sunysb.edu/morph/>    
> software    
  > Utility programs    
  Download tpsUtil  
  > Thin-plate spline
  Downlaod tpsRelw   
  Download tpsSmall     

<http://swordtail.tamu.edu/anyfish/Modeling_body_and_fin_shape_%28morphometrics%29>
1. Build a TPS file using tpsUtil   
2. Open tpsUtil    
  * Build tps file from images      
  * Input directory -> go to file with images   
  * Output to create file where you'll save info  
  * Setup - check all of images you want, create   
  
3. Can view that setup file in a text editor   
  * LM=0 : "landmark ID"    
  * info for each image selected     
  * after the landmarks are set, that LM will have numbers for each.    
  
4. Landmark tps files    
  * Open tpsDig    
  * Open tps file    
  * Input source, open the tps file   
  * Set scale: Options>Image tools or tool bar picture with tools images    
  ** a) Measure tab    
        Reference length - scale to image   
        Set scale > click and click along ruler   
     b) Apply landmark > Digitize landmarks (circle and cross image button)    
        cursor becomes circle cross   
        click on landmarks - the first and 22nd are identical (or some number - the midway?)    
        match landmarking guide - exact order of landmarks in each image    
        number and order must match all     
        File > Save data > save and overwrite  
      c) Visulaization aids    
        * Menu > preliminatries > option: create or edit wireframe   
        * Menu > file > option: import outline file    
      d) Convert TPS into NTS     
        * TPSUtil, convert TPS/NTS file   
        * check box for using the sacale factor    
        * check box for using image names as labels  
      e) Procrustes superimposed   
        * Menu > preliminatries> option: Procrustes fit  
        
5. TPSSmall - test whether variation in shape is too large   
  * regresses through the origin the set of Euclidean distances in the Euclidean space onto the set of Procrutes shape distances      
  * want approximation to give regression with both slope and correlation virtually equal to 1    

6. Consensus file (An average of a population)   
  * Open tpsRelw    
      * Landmark all LMs, combine and generate a consensus for that population   
  * Data > open the TPS file   
  * Compute > Consensus   
    * Display > Consensus   
      * see the cons   
      * File > Save > Save consensus... > Save with ".TPS"    

Landmark data
```{r}
sites <- c("AS","BR","FR","RN","TC")

landmarks <- lapply(sites, function(x){
  site <- read.csv(paste("Q:/Research/All_Projects_by_Species/Phacelia SPECIES/Phacelia_formosula/Phacelia formosula_abiotic/Landmark_",x,".csv", sep=""), header=FALSE)
  sitexy <- site[complete.cases(site),]
  colnames(sitexy) <- c("X","Y")
  ind <- seq(23,nrow(site),25)
  indivduals <- sapply(gsub(".*[=]|[.].*", "", site[ind,1]), function(x) rep(x,21))
  sitexy$Ind <- c(indivduals)
  sitexy$Ldm <- rep(1:21,nrow(sitexy)/21)
  sitexy
})

ldms <- do.call(rbind,landmarks)
head(ldms)


#each column as a landmark
head(ldms)

wide.ldms <- reshape(ldms, idvar="Ind", timevar = "Ldm", direction = "wide")


```




Edwards Knowles 2014 PRSB
```{r}
library(MASS)
library(cluster)
library(dendextend)
library("ape")

# Hausdorf & Hennig followed: 4 dimensions retained so no more than five individuals needed to recognize a cluster
phdaisy_wide <- daisy(wide.ldms[,-1], metric="gower")
phclust_wide <- hclust(phdaisy_wide)

ph.dendwide <- as.dendrogram(phclust_wide)



### When landmarks are taken together:
phdaisy <- daisy(ldms[,1:2], metric= "gower")
phclust <- hclust(phdaisy)

ph.dend <- as.dendrogram(phclust)

labelColors <- c("#CDB380", "#036564", "#EB6841")
# cut dendrogram in 4 clusters
clusMember = cutree(phclust, 3)
# function to get color labels
colLab <- function(n) {
    if (is.leaf(n)) {
        a <- attributes(n)
        labCol <- labelColors[clusMember[which(names(clusMember) == a$label)]]
        attr(n, "nodePar") <- c(a$nodePar, lab.col = labCol)
    }
    n
}
# using dendrapply
clusDendro = dendrapply(ph.dend, colLab)
# make plot
plot(clusDendro, main = "Cool Dendrogram", type = "triangle")

plot(as.phylo(ph.dend), type = "unrooted", cex=2, no.margin=TRUE)


plot(phclust, labels = ldms$Ind, cex = 0.25)

#look at part of dendrogram
plot(cut(as.dendrogram(phclust), h = 0.8)$lower[[1]])



isoMDS()
```


  