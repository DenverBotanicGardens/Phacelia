---
title: "Morphometrics"
author: "Michelle DePrenger-Levin"
date: "November 11, 2016"
output: pdf_document
---

```{r, eval=FALSE}
install.packages("shapes")
library(shapes)
```


<http://life.bio.sunysb.edu/morph/>    
> software    
  > Utility programs    
  Download tpsUtil  
  > Thin-plate spline
  Downlaod tpsRelw   
  Download tpsSmall     

<http://swordtail.tamu.edu/anyfish/Modeling_body_and_fin_shape_%28morphometrics%29>
1. Build a TPS file using tpsUtil   
2. Open tpsUtil    
  * Build tps file from images      
  * Input directory -> go to file with images   
  * Output to create file where you'll save info  
  * Setup - check all of images you want, create   
  
3. Can view that setup file in a text editor   
  * LM=0 : "landmark ID"    
  * info for each image selected     
  * after the landmarks are set, that LM will have numbers for each.    
  
4. Landmark tps files    
  * Open tpsDig    
  * Open tps file    
  * Input source, open the tps file   
  * Set scale: Options>Image tools or tool bar picture with tools images    
  ** a) Measure tab    
        Reference length - scale to image   
        Set scale > click and click along ruler   
     b) Apply landmark > Digitize landmarks (circle and cross image button)    
        cursor becomes circle cross   
        click on landmarks - the first and 22nd are identical (or some number - the midway?)    
        match landmarking guide - exact order of landmarks in each image    
        number and order must match all     
        File > Save data > save and overwrite  
      c) Visulaization aids    
        * Menu > preliminatries > option: create or edit wireframe   
        * Menu > file > option: import outline file    
      d) Convert TPS into NTS     
        * TPSUtil, convert TPS/NTS file   
        * check box for using the sacale factor    
        * check box for using image names as labels  
      e) Procrustes superimposed   
        * Menu > preliminatries> option: Procrustes fit  
        
5. TPSSmall - test whether variation in shape is too large   
  * regresses through the origin the set of Euclidean distances in the Euclidean space onto the set of Procrutes shape distances      
  * want approximation to give regression with both slope and correlation virtually equal to 1    

6. Consensus file (An average of a population)   
  * Open tpsRelw    
      * Landmark all LMs, combine and generate a consensus for that population   
  * Data > open the TPS file   
  * Compute > Consensus   
    * Display > Consensus   
      * see the cons   
      * File > Save > Save consensus... > Save with ".TPS"    

Landmark data
```{r}
sites <- c("AS","BR","FR","RN","TC")

landmarks <- lapply(sites, function(x){
  site <- read.csv(paste("Q:/Research/All_Projects_by_Species/Phacelia SPECIES/Phacelia_formosula/Phacelia formosula_abiotic/Landmark_",x,".csv", sep=""), header=FALSE)
  sitexy <- site[complete.cases(site),]
  colnames(sitexy) <- c("X","Y")
  ind <- seq(23,nrow(site),25)
  indivduals <- sapply(gsub(".*[=]|[.].*", "", site[ind,1]), function(x) rep(x,21))
  sitexy$Ind <- c(indivduals)
  sitexy$Ldm <- rep(1:21,nrow(sitexy)/21)
  sitexy
})

ldms <- do.call(rbind,landmarks)
head(ldms)



```




Edwards Knowles 2014 PRSB
```{r}
library(MASS)
library(cluster)
library(dendextend)

# Hausdorf & Hennig followed: 4 dimensions retained so no more than five individuals needed to recognize a cluster
phdaisy <- daisy(ldms[,1:2], metric= "gower")
phclust <- hclust(phdaisy)

ph.dend <- as.dendrogram(phclust)
ph.dend <- ph.dend %>%
         color_branches(k = 3) %>%
         set("branches_lwd", c(2,1,2)) %>%
         set("branches_lty", c(1,2,1))

plot(ph.dend)


############
# get some colors
cols_branches <- c("darkred", "forestgreen", "orange", "blue")
# Set the colors of 4 branches
dend1 <- color_branches(dend1, k = 4, col = cols_branches)
# or with:
# dend1 <- set(dend1, "branches_k_color", k = 4, value = cols_branches)

# get the colors of the tips of the dendrogram:
# col_labels <- cols_branches[cutree(dend1, k = 4)] # this may need tweaking in various cases - the following is a more general solution.

# The following code will work on its own once I uplode dendextend 0.18.6 to CRAN - but that can 
# take several good weeks until that happens. In the meantime
# Either use devtools::install_github('talgalili/dendextend')
# Or just the following:
source("https://raw.githubusercontent.com/talgalili/dendextend/master/R/attr_access.R")

col_labels <- get_leaves_branches_col(dend1)
# But due to the way heatmap.2 works - we need to fix it to be in the 
# order of the data!    
col_labels <- col_labels[order(order.dendrogram(dend1))]


# Creating Heat Map
if(!require(gplots)) install.packages("gplots")
library(gplots)
heatmap.2(test,  
        main = paste( "test"),  
        trace="none",          
        margins =c(5,7),      
        col=my_palette,        
        breaks=col_breaks,     
        dendrogram="row",      
        Rowv = dend1,  
        Colv = "NA", 
        key.xlab = "Concentration (index)",
        cexRow =0.6,
        cexCol = 0.8,
        na.rm = TRUE,
        RowSideColors = col_labels, # to add nice colored strips        
        colRow = col_labels # to add nice colored labels - only for qplots 2.17.0 and higher
        ) 
##########

plot(phclust, labels = ldms$Ind, cex = 0.6, hang = 0.5)

isoMDS()
```


  